<!-- Navbar -->
<div class="navbar">
  <div class="navbar-left">
    <h1 class="logo" routerLink="/home" style="cursor: pointer;">FILMOSPHERE</h1>
  </div>

  <div class="nav-link-wrapper">
    <a class="nav-link" routerLink="/film-search" routerLinkActive="active">
      <i class="pi pi-search"></i>
      <span>Search & Filter Films</span>
    </a>
  </div>

  <div class="nav-link-wrapper">
    <a class="nav-link" routerLink="/user-search" routerLinkActive="active">
      <i class="pi pi-users"></i>
      <span>Search Users</span>
    </a>
  </div>

  <div class="nav-link-wrapper">
    <a class="nav-link" routerLink="/recommendation-chat" routerLinkActive="active">
      <i class="pi pi-comments"></i>
      <span>Recommendation Chat</span>
    </a>
  </div>

  <div class="navbar-right profile-menu-trigger" (click)="profileMenu.toggle($event)">
    <p-avatar 
      *ngIf="avatarImage"
      [image]="avatarImage"
      shape="circle"
      style="width:50px; height:50px;">
    </p-avatar>

    <p-avatar 
      *ngIf="!avatarImage && avatarLabel"
      [label]="avatarLabel"
      shape="circle"
      style="background:#e50914; color:white; width:50px; height:50px; font-size:20px;">
    </p-avatar>

    <span class="username">{{ user?.username || 'Guest' }}</span>
    <i class="pi pi-chevron-down dropdown-arrow"></i>
  </div>
</div>

<p-popover 
  #profileMenu 
  appendTo="body" 
  [style]="{width: '230px'}" 
  styleClass="profile-dropdown-panel"
>
  <p-menu [model]="menuItems"></p-menu>
</p-popover>

<div class="film-page-container min-h-screen bg-[#14181c] font-sans text-gray-300 pb-20" *ngIf="film">

  <div class="backdrop-wrapper">
    <div class="backdrop-image" 
         [style.backgroundImage]="'url(' + (film.backdropUrl || 'assets/placeholder-backdrop.jpg') + ')'">
    </div>
    <div class="backdrop-overlay"></div>
  </div>

  <div class="container mx-auto px-4 relative z-10 -mt-32">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">

      <div class="lg:col-span-3 flex flex-col gap-6">
        
        <div class="poster-card rounded-lg border border-gray-700/50 shadow-2xl overflow-hidden aspect-[2/3]">
          <img [src]="film.posterUrl || film.metadata?.primaryImage?.url || 'https://via.placeholder.com/300x450'" 
               [alt]="film.title" 
               class="w-full h-full object-cover hover:scale-105 transition-transform duration-500" />
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button pButton 
                    [icon]="isWatched ? 'pi pi-eye' : 'pi pi-eye-slash'" 
                    [label]="isWatched ? 'Watched' : 'Watch'" 
                    [class]="isWatched ? 'p-button-success' : 'p-button-outlined p-button-secondary'"
                    class="w-full text-sm font-bold action-btn"
                    (click)="toggleWatched()">
            </button>
            <button pButton icon="pi pi-pencil" label="Review" 
                    class="p-button-outlined p-button-secondary w-full text-sm font-bold action-btn"
                    (click)="openReviewDialog()">
            </button>
            <button pButton icon="pi pi-list" label="Add to List" 
                    class="p-button-outlined p-button-secondary w-full text-sm font-bold action-btn"
                    (click)="openListDialog()">
            </button>
        </div>

        <div class="bg-[#1e2328] p-4 rounded border border-gray-700 text-center">
            <span class="text-xs text-gray-500 uppercase tracking-widest font-bold mb-2 block">Your Rating</span>
            <div class="flex flex-col items-center gap-2">
                <p-rating [(ngModel)]="overallRating" 
                          (onRate)="openRatingDialog($event.value)" 
                          styleClass="blue-stars scale-110">
                </p-rating>
                <button *ngIf="overallRating > 0" 
                        (click)="openRatingDialog()"
                        class="text-xs text-blue-400 hover:text-white transition-colors mt-1">
                    Edit details
                </button>
            </div>
        </div>

        <div class="bg-[#1e2328] p-4 rounded border border-gray-700">
             <h3 class="text-xs text-gray-500 uppercase tracking-widest font-bold mb-3 border-b border-gray-700 pb-2">Mood Tracker</h3>
             <div class="flex flex-col gap-3">
                 <div class="flex justify-between items-center">
                     <span class="text-sm text-gray-400">Before</span>
                     <p-select [options]="moodOptions" [(ngModel)]="userMood.mood_before" 
                               (onChange)="saveMood()" placeholder="-" 
                               styleClass="p-select-sm custom-dropdown w-24">
                     </p-select>
                 </div>
                 <div class="flex justify-between items-center">
                     <span class="text-sm text-gray-400">After</span>
                     <p-select [options]="moodOptions" [(ngModel)]="userMood.mood_after" 
                               (onChange)="saveMood()" placeholder="-"
                               styleClass="p-select-sm custom-dropdown w-24">
                     </p-select>
                 </div>
             </div>
        </div>

        <div class="synopsis pt-4 border-t border-gray-800">
            <h3 class="text-gray-500 text-xs font-bold uppercase tracking-widest mb-2">Synopsis</h3>
            <p class="text-sm text-gray-300 leading-relaxed font-serif opacity-90 text-justify break-words">
                {{ film.description }}
            </p>
        </div>

      </div> 
                <div class="lg:col-span-9 pt-0 lg:pt-12 flex flex-col gap-8 min-w-0">
                
                <div class="header-content border-b border-gray-800 pb-6">
                    <h1 class="text-4xl md:text-6xl font-serif font-bold text-white mb-2 leading-tight">
                        {{ film.title }} 
                        <span class="text-gray-500 text-3xl font-sans font-light"> {{ film.year }}</span>
                    </h1>

                    <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm md:text-base text-gray-400 mt-3">
                        <span *ngIf="film.director" class="flex items-center gap-2">
                            Directed by <span class="text-white font-semibold hover:text-blue-400 cursor-pointer transition-colors">{{ film.director }}</span>
                        </span>
                        <span *ngIf="film.duration" class="bg-gray-800 px-2 py-0.5 rounded text-xs text-gray-300">{{ film.duration }}</span>
                        
                        <div class="flex gap-2 ml-auto">
                            <p-tag *ngFor="let genre of film.genres" [value]="genre" styleClass="custom-tag"></p-tag>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 mt-4 bg-gray-900/50 w-fit px-3 py-1 rounded-full border border-gray-800">
                        <span class="text-xs uppercase font-bold text-green-500">Avg Rating</span>
                        <p-rating [ngModel]="film.rating_statistics.overall" [readonly]="true" styleClass="gold-stars text-sm"></p-rating>
                        <span class="text-xs text-gray-500 border-l border-gray-700 pl-3">{{ film.rating_statistics.total_ratings }} ratings</span>
                    </div>
                </div>

                <!-- Cast & Crew Section -->
                <div class="mt-8 w-full">
                    <h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-wider border-b border-[#333] pb-2">Cast & Crew</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 w-full">
                        <div *ngFor="let actor of film.cast" class="cast-card bg-[#1a1a1a] rounded border border-[#333] group overflow-hidden hover:border-[#e50914] transition-all duration-200">
                            <div class="portrait-ratio bg-gray-800 relative w-full pt-[150%]">
                                <img [src]="actor.profileUrl || 'assets/placeholder-person.png'" [alt]="actor.name" class="absolute top-0 left-0 w-full h-full object-cover" loading="lazy" />
                            </div>
                            <div class="p-3 text-center">
                                <div class="font-bold text-gray-200 text-sm truncate">{{ actor.name }}</div>
                                <div class="text-xs text-gray-500 truncate mt-1">{{ actor.role }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div class="mt-8 w-full">
                    <div class="flex items-center justify-between mb-4 border-b border-[#333] pb-2">
                        <h2 class="text-2xl font-bold text-white uppercase tracking-wider">
                            Reviews <span class="text-gray-500 text-lg">({{reviews.length || 0}})</span>
                        </h2>
                    </div>
                    
                    <div class="space-y-4 w-full">
                        
                        <div *ngIf="!reviews?.length" class="text-center py-12 border-2 border-dashed border-[#333] rounded-xl bg-black/50 w-full">
                            <p class="text-gray-500">No reviews yet. Be the first to write one!</p>
                        </div>

                        <div *ngFor="let review of reviews" class="w-full bg-[#111] border border-[#333] rounded-lg p-5 hover:border-[#555] transition-all duration-200">
                            
                            <!-- Header with user info and metadata -->
                            <div class="flex items-start justify-between mb-4 pb-3 border-b border-[#333]">
                                <div class="flex items-center gap-3 flex-1 min-w-0">
                                    <!-- Avatar -->
                                    <div class="w-10 h-10 rounded-full bg-[#e50914] flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                                        {{ review.username?.charAt(0)?.toUpperCase() || 'U' }}
                                    </div>
                                    
                                    <!-- User info and title -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-bold text-white text-base">
                                                {{ review.username || 'Anonymous' }}
                                            </span>
                                            <span class="text-xs text-gray-600">•</span>
                                            <span class="text-xs text-gray-500">
                                                {{ review.created_at | date:'mediumDate' }}
                                            </span>
                                        </div>
                                        
                                        <h3 *ngIf="review.title" class="text-sm font-semibold text-gray-400 truncate">
                                            {{ review.title }}
                                        </h3>
                                    </div>
                                </div>
                                
                                <!-- Rating and spoiler badge -->
                                <div class="flex items-center gap-3 flex-shrink-0">
                                    <div *ngIf="review.rating" class="flex items-center">
                                        <p-rating [ngModel]="review.rating" [readonly]="true" styleClass="tiny-stars"></p-rating>
                                    </div>
                                    
                                    <span *ngIf="review.contains_spoiler" class="text-[10px] uppercase font-bold text-[#e50914] border border-[#e50914]/50 bg-[#e50914]/10 px-2 py-1 rounded">
                                        ⚠️ Spoiler
                                    </span>
                                </div>
                            </div>

                            <!-- Review content -->
                            <div class="mb-4">
                                <!-- Spoiler warning -->
                                <div *ngIf="review.contains_spoiler && !review.isRevealed" 
                                    class="bg-[#e50914]/10 border-2 border-[#e50914]/50 rounded-lg p-4 text-center cursor-pointer hover:border-[#e50914] hover:bg-[#e50914]/20 transition-all duration-200"
                                    (click)="toggleSpoiler(review)">
                                    <div class="flex items-center justify-center gap-2">
                                        <i class="pi pi-eye-slash text-[#e50914] text-lg"></i>
                                        <span class="text-[#e50914] font-bold text-sm uppercase tracking-wide">Spoiler Warning</span>
                                    </div>
                                    <span class="text-gray-500 text-xs mt-2 block">Click to reveal content</span>
                                </div>

                                <!-- Actual content -->
                                <p *ngIf="!review.contains_spoiler || review.isRevealed" 
                                   class="text-gray-300 text-sm leading-relaxed whitespace-pre-line">
                                    {{ review.content }}
                                </p>
                            </div>

                            <!-- Footer with like button -->
                            <div class="flex items-center justify-between pt-3 border-t border-[#333]">
                                <button (click)="toggleLike(review)" 
                                        [disabled]="!isLoggedIn()"
                                        class="flex items-center gap-2 px-3 py-1.5 rounded-full transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                        [ngClass]="review.is_liked ? 'bg-[#e50914]/20 text-[#e50914] hover:bg-[#e50914]/30' : 'text-gray-500 hover:text-[#e50914] hover:bg-[#e50914]/10'">
                                    <i class="pi text-base" [ngClass]="review.is_liked ? 'pi-heart-fill' : 'pi-heart'"></i>
                                    <span class="text-xs font-medium">{{ review.likes_count || 0 }}</span>
                                </button>
                            </div>

                        </div>
                        
                    </div>
                </div>

                </div> </div> </div> 

<p-dialog header="Write a Review"
          [(visible)]="showReviewDialog"
          [modal]="true"
          [draggable]="false"
          [resizable]="false"
          [style]="{width: '520px', maxWidth: '90vw'}"
          styleClass="dark-dialog review-dialog">

  <div class="review-form">

    <input type="text"
           pInputText
           [(ngModel)]="newReview.title"
           placeholder="Review Title"
           class="input-full" />

    <textarea pTextarea
              [(ngModel)]="newReview.content"
              rows="6"
              placeholder="Write your thoughts..."
              class="input-full review-textarea"
              style="resize: none;">
    </textarea>

    <div class="review-actions">
      <button pButton label="Cancel" class="p-button-text text-gray-400" (click)="showReviewDialog=false"></button>
      <button pButton label="Post Review" class="p-button-success" (click)="submitReview()"></button>
    </div>

  </div>

  </p-dialog>



<p-dialog header="Rate this Film"

          [(visible)]="showRatingDialog"

          [modal]="true"

          [style]="{width: '480px', maxWidth: '90vw'}"

          styleClass="dark-dialog rating-dialog"

          [draggable]="false"

          [resizable]="false">



    <div class="rating-form">

       

        <div class="overall-block">
            <span class="overall-label">Overall Score</span>
            <p-rating [(ngModel)]="tempRating.overall_rating"
                      styleClass="large-gold-stars justify-center flex gap-1">
            </p-rating>
            <div class="overall-value">
                {{ tempRating.overall_rating || 0 }}<span class="overall-max">/5</span>
            </div>
        </div>



        <div class="breakdown-block">

            <h4 class="breakdown-title">Detailed Breakdown</h4>

           

            <div class="breakdown-list">

                <div *ngFor="let aspect of ratingAspects" class="breakdown-row">

                    <label class="breakdown-label">{{ aspect.label }}</label>

                    <div class="flex items-center gap-3">

                        <p-rating

                            [ngModel]="tempRating[aspect.key]"

                            (ngModelChange)="tempRating[aspect.key]=$event; updateCalculatedAverage()"

                            styleClass="small-stars">

                        </p-rating>

                    </div>

                </div>

            </div>

        </div>



        <div class="rating-actions">

            <button pButton

                    label="Remove"

                    icon="pi pi-trash"

                    class="p-button-text p-button-danger p-button-sm"

                    (click)="deleteRating()"

                    *ngIf="userRating.overall_rating">

            </button>

           

            <div class="actions-right">

                <button pButton

                        label="Cancel"

                        class="p-button-text text-gray-400"

                        (click)="showRatingDialog=false">

                </button>

                <button pButton

                        label="Save Rating"

                        class="p-button-success"

                        [disabled]="!tempRating.overall_rating"

                        (click)="submitRating()">

                </button>

            </div>

        </div>

    </div>

</p-dialog>

<!-- Add to List Dialog -->
<p-dialog 
  header="Add to List" 
  [(visible)]="showListDialog" 
  [modal]="true"
  [style]="{ width: '500px' }"
  styleClass="dark-dialog">
  
  <div *ngIf="userLists.length === 0" class="empty-lists">
    <p>You don't have any lists yet.</p>
    <p-button label="Create a List" icon="pi pi-plus" 
      (click)="goToLists()" 
      styleClass="p-button-danger"></p-button>
  </div>

  <div *ngIf="userLists.length > 0" class="lists-selection">
    <div *ngFor="let list of userLists" class="list-item-checkbox">
      <p-checkbox 
        [ngModel]="list.hasFilm" 
        [binary]="true"
        [inputId]="'list-' + list.id"
        (click)="toggleFilmInList(list, $event)"
        [readonly]="true">
      </p-checkbox>
      <label [for]="'list-' + list.id" class="list-label" (click)="toggleFilmInList(list, $event)">
        <div class="list-info">
          <strong>{{ list.title }}</strong>
          <span *ngIf="list.description" class="list-desc">{{ list.description }}</span>
          <span class="list-meta">{{ list.films_count || 0 }} films</span>
        </div>
      </label>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Create New List" icon="pi pi-plus" 
      (click)="goToLists()" 
      styleClass="p-button-outlined"></p-button>
    <p-button label="Close" icon="pi pi-times" 
      (click)="closeListDialog()" 
      styleClass="p-button-secondary"></p-button>
  </ng-template>
</p-dialog>

</div>