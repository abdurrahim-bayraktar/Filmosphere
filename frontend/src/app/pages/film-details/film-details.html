<div class="film-page-container" *ngIf="film">
  
  <div class="backdrop-wrapper">
    <div class="backdrop-image" 
         [style.backgroundImage]="'url(' + (film.backdropUrl || 'assets/placeholder-backdrop.jpg') + ')'">
    </div>
    <div class="backdrop-overlay"></div>
  </div>

  <div class="content-wrapper container mx-auto px-4 relative z-10">
    <div class="flex flex-col md:flex-row gap-8">
      
      <div class="poster-section flex-shrink-0 mx-auto md:mx-0">
        <div class="poster-card shadow-xl">
          <img [src]="film.posterUrl || film.metadata?.primaryImage?.url || 'https://via.placeholder.com/300x450'" 
               [alt]="film.title" 
               class="w-full h-auto rounded-lg" />
        </div>
        
        <div class="action-panel mt-4 flex flex-col gap-2">
           <div class="flex gap-2 justify-center">
             <button pButton 
                     [icon]="isWatched ? 'pi pi-eye' : 'pi pi-eye-slash'" 
                     [label]="isWatched ? 'Watched' : 'Watch'" 
                     [class.p-button-success]="isWatched"
                     [class.p-button-outlined]="!isWatched"
                     class="w-full action-btn"
                     (click)="toggleWatched()">
             </button>
             
             <button pButton icon="pi pi-pencil" label="Review" 
                     class="p-button-outlined w-full action-btn"
                     (click)="openReviewDialog()">
             </button>
           </div>
        </div>
      </div>

      <div class="details-section flex-grow text-center md:text-left">
        
        <h1 class="film-title text-4xl md:text-6xl font-bold text-white mb-2">
          {{ film.title }} 
          <span class="text-gray-400 text-2xl md:text-4xl font-normal">({{ film.year }})</span>
        </h1>
        
        <div class="meta-info text-gray-400 mb-6 flex flex-wrap justify-center md:justify-start gap-4 items-center">
            <span class="director" *ngIf="film.director">
                Directed by <span class="text-white font-semibold cursor-pointer hover:text-red-500">{{ film.director }}</span>
            </span>
            <span *ngIf="film.director && film.duration">•</span>
            <span class="duration" *ngIf="film.duration">{{ film.duration }}</span>
            <span *ngIf="film.genres?.length">•</span>
            <div class="genres flex gap-2">
                <p-tag *ngFor="let genre of film.genres" [value]="genre" styleClass="custom-tag"></p-tag>
            </div>
        </div>

        <div class="rating-display mb-8 flex flex-col md:flex-row items-center gap-4 mt-6">
            <div class="avg-rating">
                <span class="text-sm text-gray-500 uppercase tracking-widest block mb-1">Global Avg</span>
                <p-rating [ngModel]="film.rating_statistics.overall" [readonly]="true" styleClass="gold-stars"></p-rating>
                <span class="text-xs text-gray-600">({{ film.rating_statistics.total_ratings }} ratings)</span>
            </div>
            
            <div class="user-rating border-l border-gray-700 pl-4 md:ml-4">
                <span class="text-sm text-gray-500 uppercase tracking-widest block mb-1">Your Rating</span>
                <p-rating [(ngModel)]="overallRating" (onRate)="onRate($event)" styleClass="blue-stars"></p-rating>
            </div>
        </div>

        <div class="mood-section bg-[#111] p-4 rounded-lg border border-[#333] mb-8 inline-block w-full md:w-auto">
            <h3 class="section-title mb-3">Mood Tracker</h3>
            <div class="flex gap-4 justify-center md:justify-start">
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 mb-1">Before</span>
                        <p-select [options]="moodOptions" [(ngModel)]="userMood.mood_before" 
                                    (onChange)="saveMood()" placeholder="Select" 
                                    styleClass="p-select-sm custom-dropdown">
                        </p-select>
                </div>
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 mb-1">After</span>
                    <p-select [options]="moodOptions" [(ngModel)]="userMood.mood_after" 
                                (onChange)="saveMood()" placeholder="Select"
                                styleClass="p-select-sm custom-dropdown">
                    </p-select>
                </div>
            </div>
        </div>

        <div class="synopsis mb-8 text-left">
            <h3 class="section-title text-[#e50914] uppercase tracking-widest border-b border-[#333] pb-1 mb-2 text-sm font-bold">Synopsis</h3>
            <p class="text-gray-300 leading-relaxed text-lg">{{ film.description }}</p>
        </div>

            <p-tabs value="0" styleClass="custom-tabs">
        <p-tablist>
            <p-tab value="0">Cast</p-tab>
            <p-tab value="1">Reviews</p-tab>
        </p-tablist>

        <p-tabpanels>
<p-tabpanel value="0">
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-2">

        <div *ngFor="let actor of film.cast" class="cast-card bg-[#222] p-3 rounded border border-[#333] group text-center">
            
            <div class="cast-image-wrapper shadow-md">
                <img [src]="actor.profileUrl || 'https://via.placeholder.com/112x160?text=No+Image'"
                     [alt]="actor.name"
                     loading="lazy" />
            </div>

            <div class="cast-text">
                <div class="font-bold text-white text-sm truncate" [title]="actor.name">
                    {{ actor.name }}
                </div>
                <div class="text-xs text-gray-500 truncate" [title]="actor.role">
                    {{ actor.role }}
                </div>
            </div>
        </div>

        <div *ngIf="!film.cast?.length" class="text-gray-500 italic col-span-full">
            No cast info available.
        </div>
    </div>
</p-tabpanel>

            <p-tabpanel value="1">
                <div class="flex flex-col gap-4 mt-2">
                    <div *ngFor="let review of film.reviews" class="review-item bg-[#222] p-4 rounded border border-[#333]">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-red-500 font-bold">{{ review.user }}</span>
                            <p-rating [ngModel]="review.rating" [readonly]="true" styleClass="small-stars"></p-rating>
                        </div>
                        <p class="text-gray-300 italic">"{{ review.comment }}"</p>
                    </div>
                    
                    <div *ngIf="!film.reviews?.length" class="text-gray-500 italic">
                        No reviews yet. Be the first to review!
                    </div>
                </div>
            </p-tabpanel>
        </p-tabpanels>
    </p-tabs>

      </div>
    </div>
  </div>

  <p-dialog header="Write a Review" [(visible)]="showReviewDialog" [modal]="true" [style]="{width: '500px'}" styleClass="dark-dialog">
      <div class="flex flex-col gap-4">
          <input type="text" pInputText [(ngModel)]="newReview.title" placeholder="Review Title" 
                 class="w-full bg-[#222] text-white border-[#444] p-2 rounded" />
          
                <textarea pTextarea [(ngModel)]="newReview.content" rows="5" 
                        placeholder="Write your thoughts..."
                        class="w-full bg-[#222] text-white border-[#444] p-2 rounded">
                </textarea>
          
          <div class="flex justify-end gap-2">
              <button pButton label="Cancel" class="p-button-text text-gray-400" (click)="showReviewDialog=false"></button>
              <button pButton label="Post Review" class="p-button-success" (click)="submitReview()"></button>
          </div>
      </div>
  </p-dialog>

</div>